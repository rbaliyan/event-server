# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## CRITICAL: Git Commit and PR Guidelines

**NEVER include any reference to Claude, AI, or automated generation in:**
- Git commit messages
- Pull request titles or descriptions
- Code comments

All commits and PRs must:
- Look completely professional and human-written
- Use conventional commit format without emojis
- Be indistinguishable from commits made by human developers
- NOT include "Generated by", "Co-Authored-By: Claude", or any AI attribution

## Project Overview

Event Server (`github.com/rbaliyan/event-server`) is a gRPC-based event pub-sub server that bridges the `event/v3` library to remote clients over gRPC, REST/JSON, WebSocket, and SSE.

## Build Commands

```bash
just build       # go build ./...
just test        # go test -v ./...
just test-race   # go test -race ./...
just lint        # golangci-lint run ./...
just fmt         # go fmt ./...
just tidy        # go mod tidy
just vulncheck   # govulncheck ./...
just proto       # Regenerate protobuf code

# Run a single test
go test -run TestName ./package/...

# CI runs: go test -v -race ./... and golangci-lint v2.8.0 with --tests=false
```

## Architecture

### Package Structure

```
event-server/
├── service/     # gRPC EventService implementation (authorizer, ack tracker, interceptors)
├── client/      # RemoteTransport implementing transport.Transport
├── gateway/     # HTTP handler: gRPC-Gateway (REST) + WebSocket + SSE
├── proto/       # Protobuf definitions and generated code
│   └── event/v1/
│       ├── event.proto         # Service definition (7 RPCs)
│       ├── event.pb.go         # Generated messages
│       ├── event_grpc.pb.go    # Generated gRPC stubs
│       └── event.pb.gw.go     # Generated gRPC-Gateway handlers
└── examples/    # Three complete examples
    ├── standalone/  # Full gRPC + HTTP server
    ├── embedded/    # Custom auth in existing gRPC server
    └── client/      # RemoteTransport + event.Bus usage
```

### Core Components

**Service (`service/service.go`)**: Implements `EventServiceServer`. Wraps a `transport.Transport` from event/v3. All RPCs go through an Authorizer. Subscribe streams messages via server-streaming with ack tracking.

**AckTracker (`service/ack_tracker.go`)**: Maps server-assigned ack IDs to transport-level message ack functions. Background reap goroutine cleans up stale entries (default: 30s timeout). NackStream() nacks all pending acks when a stream closes.

**RemoteTransport (`client/transport.go`)**: Implements `transport.Transport` interface from event/v3. Connects to the gRPC server and translates all operations. Includes circuit breaker, retry with exponential backoff, and subscribe reconnection.

**Gateway (`gateway/handler.go`)**: HTTP handler that composes gRPC-Gateway (REST) with custom WebSocket and SSE handlers. Routes: `GET /v1/events/{name}/subscribe` (WS), `GET /v1/events/{name}/stream` (SSE), everything else to gRPC-Gateway.

### Data Flow

```
Publish: Client → gRPC/REST → Service.Publish() → transport.Publish()
Subscribe (gRPC): Client ← stream Message ← Service.Subscribe() ← transport.Subscribe()
Subscribe (WS): Browser ↔ WebSocket ↔ gRPC stream (or in-process) ↔ transport
Subscribe (SSE): Browser ← SSE ← gRPC stream (or in-process) ← transport
Ack: Client → Ack RPC → AckTracker → message.Ack()
```

### Error Mapping

Transport errors from event/v3 are mapped to gRPC status codes:
- `ErrTransportClosed` → `codes.Unavailable`
- `ErrEventNotRegistered` → `codes.NotFound`
- `ErrEventAlreadyExists` → `codes.AlreadyExists`
- `ErrPublishTimeout` → `codes.DeadlineExceeded`
- `ErrSubscriptionClosed` → `codes.Aborted`
- `ErrNoSubscribers` → `codes.FailedPrecondition`

The client's `fromGRPCError()` reverses this mapping.

## Preferred Architecture Patterns

### Functional Options

All packages use `New(args, ...Option)` with unexported option structs:

```go
type Option func(*options)
type options struct { /* unexported fields */ }
```

### Interface-Based Design

- `service.Authorizer` for pluggable authorization
- `transport.Transport` from event/v3 as the core abstraction
- Gateway supports both remote (gRPC client) and in-process (direct service call) modes

### Concurrency Patterns

- `sync.RWMutex` for connection state in RemoteTransport
- `atomic.Int32` for lock-free state management
- Goroutine-per-concern: receive loop, ack reader, heartbeat (all in WebSocket/SSE handlers)
- Channel-based communication between goroutines

### Key Design Decisions

- **Ack-over-RPC** (not bidirectional streaming): Subscribe is server-streaming; acks go through a separate Ack RPC. This simplifies the protocol and allows batch acking.
- **DenyAll default authorizer**: Forces explicit authorization configuration.
- **In-process gateway mode**: `NewInProcessHandler` calls the service directly without gRPC serialization overhead. Useful for embedded deployments.
- **Source from metadata**: `x-source` gRPC metadata header sets the message source; defaults to "remote".

## Code Style

- `ctx context.Context` as first parameter
- Return value types, not pointers to value types
- Unexport internal types; only expose Option functions and interfaces
- No panics except `NewService()` with nil transport
- Generated proto files are committed (not regenerated in CI)

## Protobuf

Generate with `just proto`. Proto source is in `proto/event/v1/event.proto`. Third-party imports (google/api) are vendored in `third_party/googleapis/`.

Package alias convention: `eventpb "github.com/rbaliyan/event-server/proto/event/v1"`

## Testing

- Service tests use `bufconn` for in-process gRPC
- Channel transport for all tests (no external dependencies)
- Gateway tests cover query parsing, header forwarding, WebSocket/SSE routing
- CI runs with `-race` flag

## Tooling

Tools managed via `.mise.toml`: Go 1.24.x, just, protoc, protoc-gen-go, protoc-gen-go-grpc, protoc-gen-grpc-gateway, govulncheck, golangci-lint v2.8.0.

Linting: `.golangci.yml` v2 config with `run.tests: false`. Enabled linters: errcheck, govet, staticcheck, unused.
